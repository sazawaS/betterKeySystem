<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MMP Key System</title>
    <link rel="stylesheet" href="/mmpKeyStyles.css">
</head>
<body>
    <div class="key-container">
        <h2>MMP Key System</h2>
        <div class="slider-wrapper"> <div class="slider-container">
            <div class="slider-track"></div>
            <div class="slider-thumb" id="sliderThumb"></div>
            <div class="checkpoint-labels">
                <span>Checkpoint 1</span>
                <span>Checkpoint 2</span>
                <span>Checkpoint 3</span>
            </div>
        </div> </div>
        <p id="key">Get Key Here:</p>
        <button id="getKey">Get Key</button>
    </div>

    <script>
        const sliderThumb = document.getElementById("sliderThumb");
        const keyDisplay = document.getElementById("key");
        const getKeyButton = document.getElementById("getKey");
        const urlParams = new URLSearchParams(window.location.search);
        const referer = document.referrer;
        let checkpoint = 1;
        let nextUrl = ""
        let key = ""
        let des = false;

        fetch("/mmp/getcheckpoint", 
        { 
            method: "POST",
            body: JSON.stringify({referrer:referer}),
            headers: {"Content-type": "application/json; charset=UTF-8"}
        })
        .then((response) => response.json())
        .then((json)=> {
            const recievedCheckpoint = json.checkpoint;
            checkpoint = recievedCheckpoint;
            console.log(checkpoint)
            console.log(referer)
            if (checkpoint > 1) {
                setSliderPosition(checkpoint - 1);
                animateSlider(checkpoint)
            }
        })

        function animateSlider(targetCheckpoint) {
            const thumbWidth = sliderThumb.offsetWidth;
            const trackWidth = document.querySelector('.slider-track').offsetWidth;
            const startPosition = parseFloat(sliderThumb.style.left) || 0; // Current position or 0
            const endPosition = ((targetCheckpoint - 1) / 2) * (trackWidth - thumbWidth);

            let currentPosition = startPosition;
            const duration = 750;
            const startTime = performance.now();

            function step(timestamp) {
                const progress = Math.min(1, (timestamp - startTime) / duration); // Calculate progress (0-1)
                currentPosition = startPosition + (endPosition - startPosition) * progress;
                sliderThumb.style.left = currentPosition + "px";

                if (progress < 1) {
                    requestAnimationFrame(step);
                }
            }

            requestAnimationFrame(step);
        }


        function setSliderPosition(checkpoint) {
            const thumbWidth = sliderThumb.offsetWidth;
            const trackWidth = document.querySelector('.slider-track').offsetWidth;
            const position = ((checkpoint - 1) / 2) * (trackWidth - thumbWidth);
            sliderThumb.style.left = position + "px";
        }

        getKeyButton.addEventListener("click", () => {
            fetch("/mmp/geturl", 
            { 
                method: "POST",
                body: JSON.stringify({referrer:referer}),
                headers: {"Content-type": "application/json; charset=UTF-8"}
            })
            .then((response) => response.json())
            .then((json)=> {

                if (checkpoint != 3) {
                    const recievedUrl = json.url;
                    console.log(recievedUrl)
                    if (recievedUrl == "") {
                        keyDisplay.innerHTML = "Warning! You seem to have tried to bypass the link! Please close this tab and open a new one to try again!"
                    } else { 
                        des = true;
                        window.location.href = recievedUrl;
                    }
                    return;
                }

                const recievedKey = json.url;
                console.log(recievedKey)
                if (recievedKey == "") {
                    keyDisplay.innerHTML = "Warning! You seem to have tried to bypass the link! Please close this tab and open a new one to try again!"
                } else {
                    keyDisplay.innerHTML = "Your key is: " + recievedKey;
                }


            })
        });

        window.addEventListener('beforeunload', function (e) {
            if (des == false) {
                fetch("/mmp/leave", {method: "POST"})
            }
        });


    </script>
</body>
</html>