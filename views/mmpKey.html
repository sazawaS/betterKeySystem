<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MMP Key System</title>
    <link rel="stylesheet" href="/mmpKeyStyles.css">
</head>
<body>
    <div class="key-container">
        <h2>MMP Key System</h2>
        <div class="slider-wrapper"> <div class="slider-container">
            <div class="slider-track"></div>
            <div class="slider-thumb" id="sliderThumb"></div>
            <div class="checkpoint-labels">
                <span>Checkpoint 1</span>
                <span>Checkpoint 2</span>
                <span>Checkpoint 3</span>
            </div>
        </div> </div>
        <p id="key">Get Key Here:</p>
        <button id="getKey">Get Key</button>
    </div>

    <script>
        const sliderThumb = document.getElementById("sliderThumb");
        const keyDisplay = document.getElementById("key");
        const getKeyButton = document.getElementById("getKey");
        const urlParams = new URLSearchParams(window.location.search);
        const referer = document.referrer;
        let checkpoint = 1;
        let nextUrl = ""

        fetch("/mmp/getcheckpoint", 
        { 
            method: "POST",
            body: JSON.stringify({referrer:referer}),
            headers: {"Content-type": "application/json; charset=UTF-8"}
        })
        .then((response) => response.json())
        .then((json)=> {
            const recievedCheckpoint = json.checkpoint;
            checkpoint = recievedCheckpoint || 1;
            nextUrl = json.nextUrl;
        })
        console.log(referer)

        function animateSlider(targetCheckpoint) {
            const thumbWidth = sliderThumb.offsetWidth;
            const trackWidth = document.querySelector('.slider-track').offsetWidth;
            const startPosition = parseFloat(sliderThumb.style.left) || 0; // Current position or 0
            const endPosition = ((targetCheckpoint - 1) / 2) * (trackWidth - thumbWidth);

            let currentPosition = startPosition;
            const duration = 500;
            const startTime = performance.now();

            function step(timestamp) {
                const progress = Math.min(1, (timestamp - startTime) / duration); // Calculate progress (0-1)
                currentPosition = startPosition + (endPosition - startPosition) * progress;
                sliderThumb.style.left = currentPosition + "px";

                if (progress < 1) {
                    requestAnimationFrame(step);
                }
            }

            requestAnimationFrame(step);
        }

        if (checkpoint > 1) {
            setSliderPosition(checkpoint - 1);
            animateSlider(checkpoint)
        }
        function setSliderPosition(checkpoint) {
            const thumbWidth = sliderThumb.offsetWidth;
            const trackWidth = document.querySelector('.slider-track').offsetWidth;
            const position = ((checkpoint - 1) / 2) * (trackWidth - thumbWidth);
            sliderThumb.style.left = position + "px";
        }

        getKeyButton.addEventListener("click", () => {
            if (nextUrl != "") {
                window.location.href = nextUrl;
            } else if (checkpoint != 1) {
                keyDisplay.innerHTML = "warning: you seem to have tried to skip the checkpoint, please close this window and try again."
            }
        });

    </script>
</body>
</html>