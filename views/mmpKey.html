<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MMP Key System</title>
    <link rel="stylesheet" href="/mmpKeyStyles.css">
</head>
<body>
    <div id="snowflakes"></div>
    <div class="key-container">
        <h2>MMP Key System</h2>
        <div class="slider-wrapper"> <div class="slider-container">
            <div class="slider-container">
                <div class="slider-track"></div>
                <div class="slider-fill" id="sliderFill"></div> <!-- New filled track -->
                <div class="slider-thumb" id="sliderThumb"></div>
                <div class="checkpoint-labels">
                    <span>Checkpoint 1</span>
                    <span>Checkpoint 2</span>
                    <span>Checkpoint 3</span>
                </div>
            </div>
        </div> </div>
        <p id="key">Get Key Here:</p>
        <button id="getKey">Get Key</button>
    </div>

    <script>

        function createSnowflakes() {
            const snowflakesContainer = document.getElementById('snowflakes');

            for (let i = 0; i < 50; i++) {
                const snowflake = document.createElement('div');
                snowflake.className = 'snowflake';
                snowflake.style.left = `${Math.random() * 100}vw`;
                snowflake.style.top = `${Math.random() * 100}vh`;
                snowflake.style.animationDuration = `${Math.random() * 5 + 5}s`; // Random fall speed
                snowflake.style.opacity = Math.random(); // Random opacity
                snowflake.style.width = `${Math.random() * 10 + 5}px`; // Random size
                snowflake.style.height = snowflake.style.width;

                snowflakesContainer.appendChild(snowflake);
            }
        }

        // Snowflake Interaction
        document.addEventListener('mousemove', (e) => {
            const snowflakes = document.querySelectorAll('.snowflake');
            const mouseX = e.clientX;
            const mouseY = e.clientY;

            snowflakes.forEach((snowflake) => {
                const rect = snowflake.getBoundingClientRect();
                const snowflakeX = rect.left + rect.width / 2;
                const snowflakeY = rect.top + rect.height / 2;

                const distance = Math.sqrt((mouseX - snowflakeX) ** 2 + (mouseY - snowflakeY) ** 2);
                const distanceVecX = (snowflakeX - mouseX)/30;
                const distanceVecY = (snowflakeY - mouseY)/30;

                if (distance < 100) { // If mouse is within 100px of the snowflake
                    const angle = Math.atan2(mouseY - snowflakeY, mouseX - snowflakeX);
                    const speed = 5; // Speed at which snowflake moves away
                    snowflake.style.transform = `translate(${distanceVecX}px, ${distanceVecY}px)`;
                }
            });
        });
        createSnowflakes()
        const sliderThumb = document.getElementById("sliderThumb");
        const keyDisplay = document.getElementById("key");
        const getKeyButton = document.getElementById("getKey");
        const urlParams = new URLSearchParams(window.location.search);
        const referer = document.referrer;
        let checkpoint = 1;
        let nextUrl = ""
        let key = ""
        let des = false;
        let alreadyGot = false;
        
        fetch("/mmp/getcheckpoint", 
        { 
            method: "POST",
            body: JSON.stringify({referrer:referer}),
            headers: {"Content-type": "application/json; charset=UTF-8"}
        })
        .then((response) => response.json())
        .then((json)=> {
            const recievedCheckpoint = json.checkpoint;
            checkpoint = recievedCheckpoint;
            console.log(checkpoint)
            if (checkpoint > 1) {
                setSliderPosition(checkpoint - 1);
                animateSlider(checkpoint)
            }
            keyDisplay.innerHTML = "Progress: " + (checkpoint-1) + "/2"
            if (checkpoint < 3) {
                getKeyButton.innerHTML = "Get checkpoint"
            } else {
                getKeyButton.innerHTML = "Get key"
                if (sessionStorage.getItem("is_reloaded")) alreadyGot = true;
                sessionStorage.setItem("is_reloaded", true);
            }
        })


        function animateSlider(targetCheckpoint) {
            const thumbWidth = sliderThumb.offsetWidth;
            const trackWidth = document.querySelector('.slider-track').offsetWidth;
            const startPosition = parseFloat(sliderThumb.style.left) || 0; // Current position or 0
            const endPosition = ((targetCheckpoint - 1) / 2) * (trackWidth - thumbWidth);

            const sliderFill = document.getElementById('sliderFill'); // Get the filled track
            const startFillWidth = parseFloat(sliderFill.style.width) || 0; // Current fill width or 0
            const endFillWidth = ((targetCheckpoint - 1) / 2) * trackWidth; // Target fill width

            let currentPosition = startPosition;
            let currentFillWidth = startFillWidth;
            const duration = 150; // Animation duration in milliseconds
            const startTime = performance.now();

            // Cubic easing function
            function easeInOutCubic(t) {
                return t < 0.5 ? 4 * t * t * t : 1 - Math.pow(-2 * t + 2, 3) / 2;
            }

            function step(timestamp) {
                const elapsed = timestamp - startTime;
                const progress = Math.min(elapsed / duration, 1); // Progress (0 to 1)
                const easedProgress = easeInOutCubic(progress); // Apply cubic easing

                // Update thumb position
                currentPosition = startPosition + (endPosition - startPosition) * easedProgress;
                sliderThumb.style.left = currentPosition + "px";

                // Update fill width
                currentFillWidth = startFillWidth + (endFillWidth - startFillWidth) * easedProgress;
                sliderFill.style.width = currentFillWidth + "px";

                if (progress < 1) {
                    requestAnimationFrame(step);
                }
            }

            requestAnimationFrame(step);
        }


        function setSliderPosition(checkpoint) {
            const thumbWidth = sliderThumb.offsetWidth;
            const trackWidth = document.querySelector('.slider-track').offsetWidth;
            const position = ((checkpoint - 1) / 2) * (trackWidth - thumbWidth);
            sliderThumb.style.left = position + "px";
        }

        getKeyButton.addEventListener("click", () => {

            if (alreadyGot) { return }
            alreadyGot = true;

            keyDisplay.classList.add("getting")
            if (checkpoint == 3) {
                keyDisplay.innerHTML = "Getting your key..."
            } else {
                keyDisplay.innerHTML = "Getting your link..."
            }

            fetch("/mmp/geturl", 
            { 
                method: "POST",
                body: JSON.stringify({referrer:referer}),
                headers: {"Content-type": "application/json; charset=UTF-8"}
            })
            .then((response) => response.json())
            .then((json)=> {

                if (checkpoint != 3) {
                    const recievedUrl = json.url;
                    console.log(recievedUrl);
                    if (recievedUrl == "") {
                        keyDisplay.innerHTML = "Warning! You seem to have tried to bypass the link! Please close this tab and open a new one to try again!"
                    } else { 
                        des = true;
                        window.location.href = recievedUrl;
                    }
                    return;
                }

                const recievedKey = json.key;
                keyDisplay.classList.remove("getting")
                console.log(recievedKey)
                if (recievedKey == "") {
                    keyDisplay.innerHTML = "Warning! You seem to have tried to bypass the link! Please close this tab and open a new one to try again!"
                } else {
                    keyDisplay.innerHTML = "Your key is: " + recievedKey;
                }


            })
        });

        window.addEventListener('beforeunload', function (e) {
            if (des == false) {
                fetch("/mmp/leave", {method: "POST"})
            }
        });


    </script>
</body>
</html>