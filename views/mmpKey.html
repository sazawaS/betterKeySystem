<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MMP Key System</title>
    <link rel="stylesheet" href="/mmpKeyStyles.css">
</head>
<body>
    <div id="snowflakes"></div>
    <div class="key-container">
        <h2>MMP Key System</h2>
        <div class="slider-wrapper"> <div class="slider-container">
            <div class="slider-container">
                <div class="slider-track"></div>
                <div class="slider-fill" id="sliderFill"></div> <!-- New filled track -->
                <div class="slider-thumb" id="sliderThumb"></div>
                <div class="checkpoint-labels">
                    <span>Checkpoint 1</span>
                    <span>Checkpoint 2</span>
                    <span>Checkpoint 3</span>
                </div>
            </div>
        </div> </div>
        <p id="key">Get Key Here:</p>
        <button id="getKey">Get Key</button>
    </div>

    <script>

        function createSnowflakes() {
            const snowflakesContainer = document.getElementById('snowflakes');

            for (let i = 0; i < 50; i++) {
                const snowflake = document.createElement('div');
                snowflake.className = 'snowflake';
                snowflake.style.left = `${Math.random() * 100}vw`;
                snowflake.style.top = `${Math.random() * 100}vh`;
                snowflake.style.animationDuration = `${Math.random() * 5 + 5}s`; // Random fall speed
                snowflake.style.opacity = Math.random(); // Random opacity
                snowflake.style.width = `${Math.random() * 10 + 5}px`; // Random size
                snowflake.style.height = snowflake.style.width;

                snowflakesContainer.appendChild(snowflake);
            }
        }

        // Snowflake Interaction
        document.addEventListener('mousemove', (e) => {
            const snowflakes = document.querySelectorAll('.snowflake');
            const mouseX = e.clientX;
            const mouseY = e.clientY;

            snowflakes.forEach((snowflake) => {
                const rect = snowflake.getBoundingClientRect();
                const snowflakeX = rect.left + rect.width / 2;
                const snowflakeY = rect.top + rect.height / 2;

                const distance = Math.sqrt((mouseX - snowflakeX) ** 2 + (mouseY - snowflakeY) ** 2);
                const distanceVecX = (snowflakeX - mouseX)/30;
                const distanceVecY = (snowflakeY - mouseY)/30;

                if (distance < 100) { // If mouse is within 100px of the snowflake
                    const angle = Math.atan2(mouseY - snowflakeY, mouseX - snowflakeX);
                    const speed = 5; // Speed at which snowflake moves away
                    snowflake.style.transform = `translate(${distanceVecX}px, ${distanceVecY}px)`;
                }
            });
        });
        createSnowflakes()

        const params = new URLSearchParams(document.location.search);
        const adToken = params.get("token")
        var gottenKeyOnce = false;
        var buttonElement = document.getElementById("getKey")
        if (sessionStorage.getItem("is_reloaded")) gottenKeyOnce = true;
        sessionStorage.setItem("is_reloaded", true);
        buttonElement.addEventListener("click", function(e) {
            if (gottenKeyOnce) {return}
            document.getElementById("key").innerHTML = "Getting key..."
            document.getElementById("key").classList.add("getting");

            fetch("/mmp", 
            { 
                method: "POST",
                body: JSON.stringify({token:adToken}),
                headers: {"Content-type": "application/json; charset=UTF-8"}
            })
            .then((response) => response.json())
            .then((json) => {
                const keyRecieved = json.key
                document.getElementById("key").classList.remove("getting");
                if (keyRecieved != "") {
                    document.getElementById("key").innerHTML = "Key recieved: " + json.key;
                } else {
                    document.getElementById("key").innerHTML = "You tried skipping the keysystem, or you already claimed a key. If you didn't, try changing browsers.";
                }
            });
            gottenKeyOnce = true;
        });

    </script>
</body>
</html>