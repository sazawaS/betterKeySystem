<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    <link rel="stylesheet" href="/adminPanelStyles.css">
</head>
<body>
    <div class="admin-panel">
        <h1>Nigga Bigga</h1>
        
        <div class="management-section">
            <h2>Script Management</h2>
            <button id="createScriptBtn">Create New Script</button>
            <button id="viewScriptsBtn">View Scripts</button>
        </div>
        
        <div class="management-section">
            <h2>Key Management</h2>
            <button id="createKeyBtn">Create New Key</button>
            <button id="viewKeysBtn">View Keys</button>
        </div>

        <!-- Create New Script Modal -->
        <div id="createScriptModal" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <h2>Create New Script</h2>
                <form id="createScriptForm">
                    <label for="scriptName">Script Name:</label>
                    <input type="text" id="scriptName" name="scriptName" required>
                    <label for="scriptContent">Script Content:</label>
                    <textarea id="scriptContent" name="scriptContent" rows="10" required></textarea>
                    <button type="submit">Save Script</button>
                </form>
            </div>
        </div>

        <!-- View Scripts Modal -->
        <div id="viewScriptsModal" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <h2>View Scripts</h2>
                <div id="scriptsList"></div>
            </div>
        </div>

        <!-- Create New Key Modal -->
        <div id="createKeyModal" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <h2>Create New Key</h2>
                <form id="createKeyForm">
                    <label for="keyName">Key:</label>
                    <input type="text" id="keyName" name="keyName" required>
                    <label for="hwid">Hwid:</label>
                    <input type="text" id="hwid" name="hwid">
                    <label for="expireTimer">Expires In:</label>
                    <input type="text" id="expireTimer" name="expireTimer" required>
                    <label for="keyTypes">Types (comma-separated):</label>
                    <input type="text" id="keyTypes" name="keyTypes" required>
                    <button type="submit">Save Key</button>
                </form>
            </div>
        </div>

        <!-- View Keys Modal -->
        <div id="viewKeysModal" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <h2>View Keys</h2>
                <div id="keysList"></div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const createScriptBtn = document.getElementById('createScriptBtn');
            const viewScriptsBtn = document.getElementById('viewScriptsBtn');
            const createKeyBtn = document.getElementById('createKeyBtn');
            const viewKeysBtn = document.getElementById('viewKeysBtn');
            const createScriptModal = document.getElementById('createScriptModal');
            const viewScriptsModal = document.getElementById('viewScriptsModal');
            const createKeyModal = document.getElementById('createKeyModal');
            const viewKeysModal = document.getElementById('viewKeysModal');
            const closeButtons = document.querySelectorAll('.close');
            const createScriptForm = document.getElementById('createScriptForm');
            const createKeyForm = document.getElementById('createKeyForm');
            const scriptsList = document.getElementById('scriptsList');
            const keysList = document.getElementById('keysList');

            // Open Create Script Modal with Animation
            function generate20LengthLetter()
            {
                const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
                let result = '';
                for (let i = 0; i < 20; i++) {
                    const randomIndex = Math.floor(Math.random() * characters.length);
                    result += characters.charAt(randomIndex);
                }
                return result;
            }
            createScriptBtn.onclick = function() {
                createScriptModal.style.display = 'block';
                createScriptModal.style.animation = 'fadeIn 0.3s ease';
            }

            // Open View Scripts Modal with Animation
            viewScriptsBtn.onclick = function() {
                viewScriptsModal.style.display = 'block';
                viewScriptsModal.style.animation = 'fadeIn 0.3s ease';
                fetchScripts();
            }

            // Open Create Key Modal with Animation
            createKeyBtn.onclick = function() {
                createKeyModal.style.display = 'block';
                createKeyModal.style.animation = 'fadeIn 0.3s ease';
                document.getElementById('keyName').value = generate20LengthLetter()
            }

            // Open View Keys Modal with Animation
            viewKeysBtn.onclick = async function() {
                viewKeysModal.style.display = 'block';
                viewKeysModal.style.animation = 'fadeIn 0.3s ease';
                await fetchKeys();
            }

            // Close Modals with Animation
            closeButtons.forEach(button => {
                button.onclick = function() {
                    const modal = button.closest('.modal');
                    modal.style.display = 'none';
                }
            });

            // Close Modal when clicking outside of it
            window.onclick = function(event) {
                if (event.target == createScriptModal || event.target == viewScriptsModal || event.target == createKeyModal || event.target == viewKeysModal) {
                    event.target.style.display = 'none';
                }
}

            // Handle Create Script Form Submission
            createScriptForm.onsubmit = function(event) {
                event.preventDefault();
                const scriptName = document.getElementById('scriptName').value;
                const scriptContent = document.getElementById('scriptContent').value;

                // Send data to server (you will handle this part)
                console.log('Script Name:', scriptName);
                console.log('Script Content:', scriptContent);

                // Clear form and close modal
                createScriptForm.reset();
                createScriptModal.style.display = 'none';
            }

            // Handle Create Key Form Submission
            createKeyForm.onsubmit = async function(event) {
                event.preventDefault();
                const keyName = document.getElementById('keyName').value;
                const hwid = document.getElementById("hwid").value;
                const expireTimer = document.getElementById('expireTimer').value;
                const keyTypes = document.getElementById('keyTypes').value;

                let data = {
                    key: keyName,
                    hwid: hwid,
                    expiresIn: expireTimer,
                    keyTypes: keyTypes,
                }
                if (!hwid || hwid == "")
                {
                    data.hwid = "unclaimed"
                }
                const url = "/admin/panel/createnewkey"
                await POST(url, data)

                createKeyForm.reset();
                createKeyModal.style.display = 'none';
            }

            // Fetch Scripts from Server
            async function fetchScripts() {
                // Simulate a POST request to fetch scripts
                // Replace this with actual fetch call to your server
                const scripts = [
                    { id: 1, name: 'Script 1', content: 'console.log("Hello World");' },
                    { id: 2, name: 'Script 2', content: 'alert("This is a script");' }
                ];

                scriptsList.innerHTML = '';
                scripts.forEach(script => {
                    const scriptItem = document.createElement('div');
                    scriptItem.className = 'script-item';
                    scriptItem.innerHTML = `
                        <span>${script.name}</span>
                        <button class="delete-btn" onclick="deleteScript(${script.id})">Delete</button>
                    `;
                    scriptsList.appendChild(scriptItem);
                });
            }

            function formatMilliseconds(milliseconds) {
                const seconds = Math.floor(milliseconds / 1000);
                const minutes = Math.floor(seconds / 60);
                const hours = Math.floor(minutes / 60);
                const days = Math.floor(hours / 24);

                const remainingSeconds = seconds % 60;
                const remainingMinutes = minutes % 60;
                const remainingHours = hours % 24;

                return {
                    days: days,
                    hours: remainingHours,
                    minutes: remainingMinutes,
                    seconds: remainingSeconds,
                };
            }
            
            // Fetch Keys from Server
            async function fetchKeys() {
                
                keysList.innerHTML = 'Getting keys...'
                const response = await fetch("/admin/panel/getkeys", {method:"POST"});
                const keys = await response.json()

                keysList.innerHTML = '';
                for (const [key,info] of Object.entries(keys))
                {  
                    const keyItem = document.createElement('div');
                    let expireTimer = "never";
                    if (info.expirationDate != "never") {
                        if (Date.now() >= info.expirationDate)
                        {
                            expireTimer = "expired"
                        } else {
                            const date = formatMilliseconds(info.expirationDate - Date.now());
                            expireTimer = date.days + "d " + date.hours + "h " + date.minutes + "m " + date.seconds + "s"
                        }
                    }
                    keyItem.className = 'key-item';
                    keyItem.innerHTML = `
                        <div class='key-info'>
                            <strong>Key:</strong> ${key}<br>
                            <strong>Hwid:</strong> ${info.hwid}<br>
                            <strong>Time Left:</strong> ${expireTimer}<br>
                            <strong>Types:</strong> ${info.types.join(', ')}
                        </div>
                        <div>
                            <button class="edit-btn" id='expire-btn'>Expire</button>
                            <button class="edit-btn" id='reset-hwid'>Reset HWID</button>
                            <button class="delete-btn">Delete</button>
                        </div>
                    `
                    keyItem.querySelector('#expire-btn').addEventListener('click', () => {
                        expireKey(key);
                    })
                    keyItem.querySelector('#reset-hwid').addEventListener('click', () => {
                        clearHwidKey(key);
                    })
                    keyItem.querySelector('.delete-btn').addEventListener('click', () => {
                        deleteKey(key);
                    })
                    keysList.appendChild(keyItem);
                }
            }

            //Key Edit System
            async function POST(url, key) {
                await fetch(url, {
                    method:"POST",
                    body:JSON.stringify({key:key}),
                    headers:{"Content-type": "application/json; charset=UTF-8"}
                });
            }
            window.expireKey = async function(key) {
                const url = "/admin/panel/expirekey";
                await POST(url, key);
                await fetchKeys();
            }
            window.clearHwidKey = async function(key) {
                const url = "/admin/panel/resethwid";
                await POST(url, key);
                await fetchKeys();
            }

            window.deleteKey = async function(key) {
                const url = "/admin/panel/deletekey";
                await POST(url, key);
                await fetchKeys();
            }
        });
    </script>
</body>
</html>